#!/usr/bin/env ruby
# coding: utf-8
require 'active_record'
require 'logger'
require 'pg'

#
# A class that creates the tables required to support ActiveRecord classes
# in a Postgresql database.
#
class AccessmonMigration
  POOL_COUNT = 5 # 5 is probably overkill, but ¯\_(ツ)_/¯
  PORT_NUMBER = 5432 # Standard Postgresql port

  # Start the logger
  def initialize
    ActiveRecord::Base.logger = Logger.new(STDOUT)
  end

  # Connect to the Postgresql database hosted on Glue
  # a connect_? method must be called before performing operations on the db
  def connect_remote
    #ENV['DATABASE_URL'] ||= "postgres://glue.pumpingstationone.org/?pool=5"
    #ActiveRecord::Base.establish_connection(ENV['DATABASE_URL'])
    ActiveRecord::Base.establish_connection(
      :adapter  => 'postgresql',
      :encoding => 'unicode',
      :database => ENV['DB_NAME'], # accessmon
      :username => ENV['DB_USERNAME'], # accessmon
      :password => ENV['DB_PASSWORD'],
      :pool     => POOL_COUNT,
      :port     => PORT_NUMBER,
      :host     => 'glue.pumpingstationone.org')
  end

  # Connect to the local database
  # a connect_? method must be called before performing operations on the db
  def connect_local
    ActiveRecord::Base.establish_connection(
      :adapter  => 'postgresql',
      :encoding => 'unicode',
      :database => ENV['DB_NAME'], # accessmon
      :username => ENV['DB_USERNAME'], # accessmon
      :password => ENV['DB_PASSWORD'],
      :pool     => POOL_COUNT,
      :port     => PORT_NUMBER,
      :host     => 'localhost')
  end

  # Connect to the local database root 'postgres'
  def connect_local_admin
    ActiveRecord::Base.establish_connection(
      :adapter  => 'postgresql',
      :schema_search_path => 'public',
      :encoding => 'unicode',
      :database => 'postgres',
      :username => ENV['DB_USERNAME'], # accessmon
      :password => ENV['DB_PASSWORD'],
      :pool     => POOL_COUNT,
      :port     => PORT_NUMBER,
      :host     => 'localhost')
  end

  # Create the database
  def create_database
    ActiveRecord::Base.connection.create_database(ENV['DB_NAME'])
  end

  # Drop the database
  def drop_database
    ActiveRecord::Base.connection.drop_database(ENV['DB_NAME'])
  end

  # Add tables and indexes to the database
  def migrate
    ActiveRecord::Schema.define do
      self.verbose = true # or false

      enable_extension "plpgsql"
      #enable_extension "pgcrypto"

      create_table(:access_lines, force: true) do |t|
        t.string   :line,      null: false
        t.datetime :timestamp, null: false
        t.string   :username,  null: false
        t.string   :peer_id,   null: false
      end

      # A backup for the uniqueness validation in AccessLine
      add_index :access_lines, [:timestamp, :username], unique: true
    end
  end

end

if __FILE__ == $0

  puts "Running Accessmon Migration..."
  db = AccessmonMigration.new

  db.connect_local_admin

  #db.drop_database
  db.create_database

  # Choose one of these two
  db.connect_local
  #db.connect_remote

  db.migrate

end
